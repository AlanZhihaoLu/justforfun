<!DOCTYPE html>
<html>
    <head>
        <link rel="icon" href="3-horizontal-dots.svg" type="image/icon type">
        <title>
            Morse Interpreter
        </title>
        <link rel="stylesheet" href="slider.css">
        <link rel="stylesheet" href="main.css"> 
    </head>
    <body>
        <!-- See: `getFullVh()` -->
        <div style="overflow: hidden; height: 0">
            <div id="measure-vh" style="position: fixed; height: 100vh"></div>
        </div>
        <div id="modal" class="modal">
            <div class="help-content modal-content">
                <span id="close-help" class="close">&times;</span>
                <p><b>What is this?</b></p>
                <p>
                    It translates morse code to letters. 
                    Just click (if using mouse) or tap (if on mobile) out morse 
                    code anywhere on the screen that's not occupied by buttons, 
                    and what you tap out will be written out in the space below.
                    Alternatively, if you have a keyboard, you can use the spacebar.
                    By default a "dit" is considered 150ms. You can change this default
                    by using the "calibrate" button.
                </p>
                <img src="International_Morse_Code.svg" alt="Morse Code Chart" style="display:block;margin-left:auto;margin-right:auto;width:50vw;">
            </div>  
            <div class="options-content modal-content">
                <span id="close-options" class="close">&times;</span>
                <p><b>Options</b></p>
                <div class="volume-container">
                    Audio Feedback Volume: <span id="volume-level">50</span>
                    <br>
                    <input type="range" min="0" max="100" value="50" class="slider" id="volume-slider" onchange="change_volume()">
                </div>
            </div>  
            <div class="cal-content modal-content">
                <span id="close-cal" class="close">&times;</span>
                <p><b>Calibrate</b></p>
                <p>Calibrate timing. By default a "dit" is considered 150ms. <i>The current dit duration is set to <input type='number' value='150' class="dit-ind" style="font-style: italic;" max="999" min="10" onchange="handle_manual_cal()">ms.</i></p>
                <p>To calibrate, press the start button and click, tap, or spacebar out the letters that appear below.</p>
                <button class='start-cal' style="font-size:5vh;">start</button>
                <div class="cal-letter-container">
                </div>
            </div>  
        </div>
        <div id="main-container">
            <div class="unselectable" style="display:flex;justify-content:flex-end;">
                <button class="cal-button" style="font-size:5vh;">calibrate</button>
                <div style="margin-left:auto;">
                    <button class="options-button" style="font-size:5vh;">options</button>
                    <button class="help-button" style="font-size:5vh;">help</button>
                </div>
            </div>
            <div class="center-container" style="align-items:flex-start;margin-top:3vh;margin-bottom:1vh;font-size:8vh;">
                <div>
                    Morse Interpreter
                </div>
            </div>
            <div>
                <div class="unselectable inputarea center-container" style="align-items:center;height:20vh;font-size:10vh;">
                    <span style="margin-left:0.2em;margin-right:10vh;">
                        <span id="interpreted" style='white-space:pre-wrap;'></span>
                        <span id="ditdahs" style='opacity:0.5;margin-left:-0.1em;'></span>
                        <span id="cursor" style='position:relative;font-size:1.2em;top:0.05em;margin-left:-0.1em;'>|</span>
                    </span>
                    <div class="light-container" style="position:absolute;right:0;">
                        <div id="light">
                        </div>
                    </div>
                </div>
                <div class="center-container" style="align-items:flex-end;margin-top:2vh;">
                    <button id="main-app" class="transmit-button unselectable" style="font-size:8vh;margin-right:1vh;">transmit</button>
                    <button class="del-button unselectable" style="font-size:8vh;">delete</button>
                </div>
            </div>
        </div>
        <div>
            <a href="receive.html">Receive!</a>
        </div>
    </body>
    <script src="morse_dicts.js"></script>
    <script src="cursor_blink.js"></script>
    <script src="absorb_event.js"></script>
    <script src="delete_button.js"></script>
    <script src="calibrate_button.js"></script>
    <script src="help_button.js"></script>
    <script src="options_button.js"></script>
    <script src="mobile_check.js"></script>
    <script>

        const getFullVh = () => {
        return document.querySelector('#measure-vh').clientHeight
        }

        var keypress_interpreter_inactive = false;

        var calibrate_on = false;

        var modal = document.getElementById("modal");
        modal.addEventListener('click', function (e) {
            e.preventDefault();
            if (e.target === modal) {
                help_content.style.display = "none";
                options_content.style.display = "none";
                cal_content.style.display = "none";
                modal.style.display = "none";
                if (calibrate_on) {
                    calibrate_on = false;
                    remove_cal_listeners();
                }
                if (keypress_interpreter_inactive) {
                    document.body.addEventListener('keydown', handle_keydown)
                    document.body.addEventListener('keyup', handle_keyup)
                }
            }
        })

        var app = document.getElementById("main-app");
        
        var audioObj = new Audio('440Hz.mp3');
        audioObj.volume = 0.2;
        var interpreted = document.querySelector('#interpreted');
        var ditdahs = document.querySelector('#ditdahs');

        var dit;
        if (localStorage.getItem('dit') === null) {
            dit = 150;
        } else {
            dit = parseInt(localStorage.getItem('dit'));
            dit_ind.value = dit;
        }

        ditdahs.innerHTML = '';
        var onMobile = window.mobileAndTabletCheck();
        var audioReady = !onMobile;
        var timeoutID;

        var ready_down = true;
        var t0;
        var dur;

        var light = document.querySelector('#light');

        function toggle_light(colorInput) {
            light.style.backgroundColor = colorInput;
        }

        function handle_mousedown(e) {
            e.preventDefault();
            if (ready_down) {
                t0 = e.timeStamp;
                if (timeoutID !== undefined) {
                    clearTimeout(timeoutID);
                }
                if (audioReady) {
                    audioObj.play()
                }
                toggle_light('yellow')
                ready_down = false;
            }
        }
        function handle_mouseup(e) {
            e.preventDefault();
            if (t0 !== undefined) {
                dur = e.timeStamp - t0;
                if (dur < (dit*2.5)) {
                    ditdahs.innerHTML = ditdahs.innerHTML + '.';
                } else {
                    ditdahs.innerHTML = ditdahs.innerHTML + '-';
                };
                timeoutID = setTimeout(interpret_morse,dit*3);
                if (audioReady) {
                    audioObj.pause()
                    audioObj.currentTime = 0;
                }
                toggle_light('white')
                ready_down = true;
            }
        }

        function handle_keydown(e) {
            if (e.keyCode === 8) {
                if (timeoutID !== undefined) {
                        clearTimeout(timeoutID);
                        if (ditdahs.innerHTML.length !== 0) {
                            ditdahs.innerHTML = ditdahs.innerHTML.slice(0, -1);
                        } else {
                            interpreted.innerHTML = interpreted.innerHTML.slice(0, -1);
                        }
                    }
                timeoutID = setTimeout(interpret_morse,dit*3);
            }
            if (e.keyCode === 32 && ready_down) {
                t0 = e.timeStamp;
                if (timeoutID !== undefined) {
                    clearTimeout(timeoutID);
                }
                if (audioReady) {
                    audioObj.play()
                }
                toggle_light('yellow')
                ready_down = false;
            }
        }

        function handle_keyup(e) {
            if (e.keyCode === 32 && t0 !== undefined) {
                dur = e.timeStamp - t0;
                if (dur < (dit*2.5)) {
                    ditdahs.innerHTML = ditdahs.innerHTML + '.';
                } else {
                    ditdahs.innerHTML = ditdahs.innerHTML + '-';
                };
                timeoutID = setTimeout(interpret_morse,dit*3);
                if (audioReady) {
                    audioObj.pause()
                    audioObj.currentTime = 0;
                }
                toggle_light('white')
                ready_down = true;
            }
        }

        function interpret_morse() {
            if (morse_dict[ditdahs.innerHTML] !== undefined) {
                interpreted.innerHTML = interpreted.innerHTML + morse_dict[ditdahs.innerHTML];
                ditdahs.innerHTML = '';
            }
            if (interpreted.innerHTML.length > 0 && !interpreted.innerHTML.endsWith(' ')) {
                timeoutID = setTimeout(function(){interpreted.innerHTML = interpreted.innerHTML + ' '},dit*4);
            }
        }

        app.addEventListener('mousedown', handle_mousedown)
        app.addEventListener('mouseup', handle_mouseup)

        document.body.addEventListener('keydown', handle_keydown)
        document.body.addEventListener('keyup', handle_keyup)

        app.addEventListener('touchstart', handle_mousedown);

        app.addEventListener('touchend', handle_mouseup);

    </script>
</html>